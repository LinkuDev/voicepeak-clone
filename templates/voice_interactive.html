<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voicepeak Interactive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col">
                <div class="row g-4">
                    <div class="col-md-5">
                        <div class="card shadow">
                            <div class="card-body">
                                <h2 class="mb-4 text-center">Voicepeak</h2>
                                <form id="voice-form">
                                    <div class="mb-3">
                                        <label for="username" class="form-label">Username:</label>
                                        <input type="text" id="username" class="form-control" value="{{ username }}" readonly disabled>
                                    </div>
                                    <div class="mb-3">
                                        <label for="voice" class="form-label">Voice:</label>
                                        <select id="voice" class="form-select">
                                            <option>Japanese Female Child</option>
                                            <option>Japanese Male 3</option>
                                            <option>Japanese Male 2</option>
                                            <option>Japanese Male 1</option>
                                            <option>Japanese Female 3</option>
                                            <option>Japanese Female 2</option>
                                            <option>Japanese Female 1</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="text-content" class="form-label">Text (mỗi dòng 1 câu):</label>
                                        <textarea id="text-content" rows="8" class="form-control"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="text-file" class="form-label">Hoặc upload file txt:</label>
                                        <input type="file" id="text-file" accept=".txt" class="form-control">
                                    </div>
                                    <input type="hidden" id="time_key" name="time_key">
                                    <button type="submit" class="btn btn-success w-100">Tạo voice</button>
                                </form>
                                <div id="alert-success" class="alert alert-success mt-4 d-none" role="alert">
                                    Đã tạo xong tất cả các dòng!
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card shadow">
                            <div class="card-body">
                                <h4 class="mb-3">Kết quả</h4>
                                <div class="result-list" id="result-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    const form = document.getElementById('voice-form');
    const resultList = document.getElementById('result-list');
    const textFile = document.getElementById('text-file');
    const textContent = document.getElementById('text-content');
    const alertSuccess = document.getElementById('alert-success');

    // Sinh time_key 1 lần duy nhất khi submit
    function genTimeKey() {
		const d = new Date();

		const year = d.getFullYear();
		const month = String(d.getMonth() + 1).padStart(2, '0');
		const day = String(d.getDate()).padStart(2, '0');
		const hours = String(d.getHours()).padStart(2, '0');
		const minutes = String(d.getMinutes()).padStart(2, '0');

		return `${day}/${month}/${year}_${hours}:${minutes}`;
	}

    form.onsubmit = async function(e) {
        e.preventDefault();
        resultList.innerHTML = '';
        alertSuccess.classList.add('d-none');
        let lines = [];
        if (textFile.files.length > 0) {
            const file = textFile.files[0];
            const content = await file.text();
            lines = content.split(/\r?\n/).map(l => l.trim()).filter(l => l);
        } else {
            lines = textContent.value.split(/\r?\n/).map(l => l.trim()).filter(l => l);
        }
        if (lines.length === 0) {
            alert('Vui lòng nhập hoặc upload nội dung!');
            return;
        }
        const username = document.getElementById('username').value.trim();
        const voice = document.getElementById('voice').value;
        let timeKey = document.getElementById('time_key').value;
        if (!timeKey) {
            timeKey = genTimeKey();
            document.getElementById('time_key').value = timeKey;
        }
        let successCount = 0;
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const item = document.createElement('div');
            item.className = 'result-item';
            item.innerHTML = `<span class="progress">Đang tạo dòng ${i+1}...</span>`;
            resultList.appendChild(item);
            const formData = new FormData();
            formData.append('username', username);
            formData.append('voice', voice);
            formData.append('line', line);
            formData.append('index', i);
            formData.append('time_key', timeKey);
            try {
                const res = await fetch('api/generate-line', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.wav_url) {
                    item.innerHTML = `<b>Dòng ${i+1}:</b> ${line}<br><audio controls src="${data.wav_url}"></audio>`;
                    successCount++;
                } else {
                    item.innerHTML = `<b>Dòng ${i+1}:</b> Lỗi: ${data.error || 'Không rõ'}<br><span>${line}</span>`;
                }
            } catch (err) {
                item.innerHTML = `<b>Dòng ${i+1}:</b> Lỗi kết nối!<br><span>${line}</span>`;
            }
        }
        if (successCount === lines.length) {
            alertSuccess.classList.remove('d-none');
            // Tự động gọi merge-audio sau khi tạo xong tất cả các dòng
            const mergeItem = document.createElement('div');
            mergeItem.className = 'result-item mt-3 alert alert-info';
            mergeItem.innerHTML = '<strong>Đang tạo file tổng hợp (full.wav & full.srt)...</strong>';
            resultList.appendChild(mergeItem);
            
            const mergeFormData = new FormData();
            mergeFormData.append('username', username);
            mergeFormData.append('time_key', timeKey);
            
            try {
                const mergeRes = await fetch('/api/merge-audio', { method: 'POST', body: mergeFormData });
                const mergeData = await mergeRes.json();
                if (mergeData.full_wav_url) {
                    mergeItem.className = 'result-item mt-3 alert alert-success';
                    mergeItem.innerHTML = `
                        <strong>✓ Đã tạo xong file tổng hợp!</strong><br>
                        <b>Tổng số dòng:</b> ${mergeData.total_lines}<br>
                        <b>Tổng thời lượng:</b> ${mergeData.total_duration_seconds.toFixed(2)}s<br>
                        <b>File âm thanh:</b> <a href="${mergeData.full_wav_url}" target="_blank">full.wav</a><br>
                        <b>File subtitle:</b> <a href="${mergeData.full_srt_url}" target="_blank">full.srt</a><br>
                        <audio controls src="${mergeData.full_wav_url}" class="mt-2 w-100"></audio>
                    `;
                } else {
                    mergeItem.className = 'result-item mt-3 alert alert-danger';
                    mergeItem.innerHTML = `<strong>✗ Lỗi khi tạo file tổng hợp:</strong> ${mergeData.error || 'Không rõ'}`;
                }
            } catch (err) {
                mergeItem.className = 'result-item mt-3 alert alert-danger';
                mergeItem.innerHTML = `<strong>✗ Lỗi kết nối khi tạo file tổng hợp!</strong>`;
            }
        }
    };
    </script>
</body>
</html>
