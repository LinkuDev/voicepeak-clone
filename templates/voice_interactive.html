<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voicepeak Interactive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col">
                <div class="row g-4">
                    <div class="col-md-5">
                        <div class="card shadow">
                            <div class="card-body">
                                <h2 class="mb-4 text-center">Voicepeak</h2>
                                <form id="voice-form">
                                    <div class="mb-3">
                                        <label for="username" class="form-label">Username:</label>
                                        <input type="text" id="username" class="form-control" value="{{ username }}" readonly disabled>
                                    </div>
                                    <div class="mb-3">
                                        <label for="voice" class="form-label">Voice:</label>
                                        <select id="voice" class="form-select">
                                            <option>Japanese Female Child</option>
                                            <option>Japanese Male 3</option>
                                            <option>Japanese Male 2</option>
                                            <option>Japanese Male 1</option>
                                            <option>Japanese Female 3</option>
                                            <option>Japanese Female 2</option>
                                            <option>Japanese Female 1</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="text-content" class="form-label">Text (m·ªói d√≤ng 1 c√¢u):</label>
                                        <textarea id="text-content" rows="8" class="form-control"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="text-file" class="form-label">Ho·∫∑c upload file txt:</label>
                                        <input type="file" id="text-file" accept=".txt" class="form-control">
                                    </div>
                                    <input type="hidden" id="time_key" name="time_key">
                                    <button type="submit" class="btn btn-success w-100">T·∫°o voice</button>
                                </form>
                                <div id="alert-success" class="alert alert-success mt-4 d-none" role="alert">
                                    ƒê√£ t·∫°o xong t·∫•t c·∫£ c√°c d√≤ng!
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card shadow">
                            <div class="card-body">
                                <h4 class="mb-3">K·∫øt qu·∫£</h4>
                                <div class="result-list" id="result-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    const form = document.getElementById('voice-form');
    const resultList = document.getElementById('result-list');
    const textFile = document.getElementById('text-file');
    const textContent = document.getElementById('text-content');
    const alertSuccess = document.getElementById('alert-success');

    // Sinh time_key 1 l·∫ßn duy nh·∫•t khi submit
    function genTimeKey() {
		const d = new Date();

		const year = d.getFullYear();
		const month = String(d.getMonth() + 1).padStart(2, '0');
		const day = String(d.getDate()).padStart(2, '0');
		const hours = String(d.getHours()).padStart(2, '0');
		const minutes = String(d.getMinutes()).padStart(2, '0');

		return `${day}.${month}.${year}_${hours}.${minutes}`;
	}

    form.onsubmit = async function(e) {
        e.preventDefault();
        resultList.innerHTML = '';
        alertSuccess.classList.add('d-none');
        let lines = [];
        if (textFile.files.length > 0) {
            const file = textFile.files[0];
            const content = await file.text();
            lines = content.split(/\r?\n/).map(l => l.trim()).filter(l => l);
        } else {
            lines = textContent.value.split(/\r?\n/).map(l => l.trim()).filter(l => l);
        }
        if (lines.length === 0) {
            alert('Vui l√≤ng nh·∫≠p ho·∫∑c upload n·ªôi dung!');
            return;
        }
        const username = document.getElementById('username').value.trim();
        const voice = document.getElementById('voice').value;
        let timeKey = document.getElementById('time_key').value;
        if (!timeKey) {
            timeKey = genTimeKey();
            document.getElementById('time_key').value = timeKey;
        }
        let successCount = 0;
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const item = document.createElement('div');
            item.className = 'result-item';
            item.innerHTML = `<span class="progress">ƒêang t·∫°o d√≤ng ${i+1}...</span>`;
            resultList.appendChild(item);
            const formData = new FormData();
            formData.append('username', username);
            formData.append('voice', voice);
            formData.append('line', line);
            formData.append('index', i);
            formData.append('time_key', timeKey);
            try {
                const res = await fetch('api/generate-line', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.wav_url) {
                    item.innerHTML = `<b>D√≤ng ${i+1}:</b> ${line}<br><audio controls src="${data.wav_url}"></audio>`;
                    successCount++;
                } else {
                    item.innerHTML = `<b>D√≤ng ${i+1}:</b> L·ªói: ${data.error || 'Kh√¥ng r√µ'}<br><span>${line}</span>`;
                }
            } catch (err) {
                item.innerHTML = `<b>D√≤ng ${i+1}:</b> L·ªói k·∫øt n·ªëi!<br><span>${line}</span>`;
            }
        }
		setTimeout(function(){
			// do sth
		}, 5000);
        if (successCount === lines.length) {
            alertSuccess.classList.remove('d-none');
            // T·ª± ƒë·ªông g·ªçi merge-audio sau khi t·∫°o xong t·∫•t c·∫£ c√°c d√≤ng
            const mergeItem = document.createElement('div');
            mergeItem.className = 'result-item mt-3 alert alert-info';
            mergeItem.innerHTML = '<strong>ƒêang t·∫°o file t·ªïng h·ª£p (full.wav & full.srt)...</strong>';
            resultList.appendChild(mergeItem);
            
            const mergeFormData = new FormData();
            mergeFormData.append('username', username);
            mergeFormData.append('time_key', timeKey);
            
            try {
                const mergeRes = await fetch('api/merge-audio', { method: 'POST', body: mergeFormData });
                const mergeData = await mergeRes.json();
                if (mergeData.full_wav_url) {
                    mergeItem.className = 'result-item mt-3 alert alert-success';
                    mergeItem.innerHTML = `
                        <strong>‚úì ƒê√£ t·∫°o xong file t·ªïng h·ª£p!</strong><br>
                        <b>T·ªïng s·ªë d√≤ng:</b> ${mergeData.total_lines}<br>
                        <b>T·ªïng th·ªùi l∆∞·ª£ng:</b> ${mergeData.total_duration_seconds.toFixed(2)}s<br>
                        <b>File √¢m thanh:</b> <a href="${mergeData.full_wav_url}" target="_blank">full.wav</a><br>
                        <b>File subtitle:</b> <a href="${mergeData.full_srt_url}" target="_blank">full.srt</a><br>
                        <audio controls src="${mergeData.full_wav_url}" class="mt-2 w-100"></audio>
                        <hr>
                        <button class="btn btn-primary w-100 mt-2" onclick="downloadZip('${username}', '${timeKey}')">
                            üì¶ T·∫£i xu·ªëng to√†n b·ªô (ZIP)
                        </button>
                    `;
                } else {
                    mergeItem.className = 'result-item mt-3 alert alert-danger';
                    mergeItem.innerHTML = `<strong>‚úó L·ªói khi t·∫°o file t·ªïng h·ª£p:</strong> ${mergeData.error || 'Kh√¥ng r√µ'}`;
                }
            } catch (err) {
                mergeItem.className = 'result-item mt-3 alert alert-danger';
                mergeItem.innerHTML = `<strong>‚úó L·ªói k·∫øt n·ªëi khi t·∫°o file t·ªïng h·ª£p!</strong>`;
            }
        }
    };

    // H√†m download zip
    async function downloadZip(username, timeKey) {
        const formData = new FormData();
        formData.append('username', username);
        formData.append('time_key', timeKey);
        
        try {
            const res = await fetch('api/download-zip', { 
                method: 'POST', 
                body: formData 
            });
            
            if (res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${username}_${timeKey.replace(/\./g, '_').replace(/:/g, '_')}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                const data = await res.json();
                alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫£i file zip'));
            }
        } catch (err) {
            alert('L·ªói k·∫øt n·ªëi khi t·∫£i file zip!');
        }
    }
    </script>
</body>
</html>
